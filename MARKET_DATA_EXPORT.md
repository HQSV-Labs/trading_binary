# 市场全量数据获取功能

## 🆕 新功能 (2025-12-26)

### 用户需求
> "目前最多只能获取500笔吗？在目前功能的基础上我想看一个已关闭市场的全部交易"

### 解决方案 ✅

## 📊 功能说明

### 1. 扩大市场交易数据限制

**之前**：
- 市场对比最多 500 笔交易
- 限制 `min(trade_limit, 500)`

**现在**：
- 可选择：100, 200, 500, 1000, 2000, 5000, **10000** 笔
- 默认：500 笔
- API 单次最多：10000 笔

### 2. 市场交易详细统计

新增市场数据统计面板：

**价格统计**：
- 最低价
- 最高价
- 平均价

**交易量统计**：
- 总交易额
- 买入总额
- 卖出总额

**时间范围**：
- 开始时间
- 结束时间
- 持续时长

### 3. 数据导出功能 🆕

**导出为 CSV 文件**：
- 包含所有交易数据
- 支持中文编码
- 可用 Excel 打开
- 便于深度分析

**CSV 包含字段**：
- 时间
- 方向（BUY/SELL）
- 价格
- 数量
- 金额
- 钱包地址
- 市场标题
- 市场链接

## 🎯 使用方法

### 查看已关闭市场的全部交易

```bash
# 1. 启动 Dashboard
./run_address_tracking.sh

# 2. 追踪地址
- 输入地址（已默认填充）
- 点击 "🔍 追踪并分析"

# 3. 筛选已关闭市场
- 筛选市场状态：选择 "🔴 只看已关闭"

# 4. 选择市场
- 从列表中选择一个已关闭的市场

# 5. 切换到市场对比
- 点击 "🔄 市场对比分析" 标签

# 6. 选择交易数量
- 市场交易数量：选择 10000（获取最多数据）

# 7. 查看数据
- 查看图表
- 展开 "📊 市场交易详细统计"
- 点击 "📥 下载 CSV" 导出数据
```

## 📈 数据量说明

### 交易数量对比

| 数量 | 适用场景 | 加载时间 | API限制 |
|-----|---------|---------|---------|
| 100 | 快速预览 | ~2秒 | ✅ |
| 500 | 常规分析 | ~5秒 | ✅ |
| 1000 | 深度分析 | ~8秒 | ✅ |
| 2000 | 详细研究 | ~12秒 | ✅ |
| 5000 | 全面分析 | ~20秒 | ✅ |
| 10000 | 最大数据 | ~30秒 | ⚠️ API上限 |

### API 限制说明

**单次请求限制**：
- Polymarket API 单次最多返回 10000 笔交易
- 如果市场交易 > 10000 笔，只能获取最近的 10000 笔
- 已关闭市场的数据不再变化，更适合全量分析

**建议**：
- 活跃市场：500-1000 笔（数据变化快）
- 已关闭市场：5000-10000 笔（获取尽可能多的历史数据）

## 💡 实际应用场景

### 场景 1：分析市场交易模式

```
选择：已关闭的 Bitcoin 15分钟市场
获取：10000 笔交易
分析：
1. 查看价格走势
2. 识别主要交易者
3. 找出交易密集时段
4. 总结成功策略
```

### 场景 2：计算市场统计数据

```
导出 CSV → Excel 分析：
- 交易量分布
- 价格分布直方图
- 交易者活跃度
- 买卖压力对比
- 时间分布热力图
```

### 场景 3：对比不同市场

```
获取多个已关闭市场的数据：
1. Bitcoin 15分钟市场 A
2. Bitcoin 15分钟市场 B
3. Bitcoin 15分钟市场 C

对比分析：
- 交易量差异
- 价格波动幅度
- 参与者数量
- 交易模式异同
```

### 场景 4：研究交易者行为

```
获取 10000 笔交易
筛选数据：
1. 找出交易量最大的钱包
2. 分析其交易时机
3. 学习其策略
4. 计算其盈亏
```

## 📥 CSV 数据示例

```csv
时间,方向,价格,数量,金额,钱包地址,市场标题,市场链接
2025-12-26 08:32:15,BUY,0.420,100,42.00,0x6ab5...,Bitcoin Up or Down - December 26,https://...
2025-12-26 08:32:18,SELL,0.580,50,29.00,0xc094...,Bitcoin Up or Down - December 26,https://...
2025-12-26 08:32:20,BUY,0.430,200,86.00,0x7db3...,Bitcoin Up or Down - December 26,https://...
...
```

## 📊 统计面板示例

```
📊 市场交易详细统计 ▼

价格统计：
- 最低价：$0.350
- 最高价：$0.720
- 平均价：$0.485

交易量统计：
- 总交易额：$125,430.50
- 买入总额：$62,845.20
- 卖出总额：$62,585.30

时间范围：
- 开始：2025-12-26 08:30:00
- 结束：2025-12-26 08:45:00
- 持续：15 分钟
```

## 🎨 界面更新

### 市场对比分析标签

```
🔄 市场对比分析

[市场交易数量: 10000 ▼] 
💡 市场交易获取：
   - 将获取最近 10000 笔交易
   - 包括所有交易者的交易
   - 数量越大，分析越全面
   
   ⚠️ 注意：
   - 10000笔可能需要 20-30秒
   - API 单次最多返回 10000 笔
   - 已关闭市场的数据更稳定

正在获取市场数据（10000 笔）...

✓ 获取到该市场的 8,542 笔交易

[总交易数: 8,542] [交易者数: 342] [买入: 4,231] [卖出: 4,311]

📊 市场交易详细统计 ▼
(展开查看统计数据)

📥 导出市场数据
[📥 下载 CSV (8,542 笔交易)]

(交易对比图表)
```

## 🔧 技术实现

### 增加交易数量选项

```python
market_trade_limit = st.selectbox(
    "市场交易数量",
    options=[100, 200, 500, 1000, 2000, 5000, 10000],
    index=2,  # 默认500
)
```

### 统计信息计算

```python
# 价格统计
prices = [t.price for t in all_trades]
min_price = min(prices)
max_price = max(prices)
avg_price = sum(prices) / len(prices)

# 交易量统计
total_volume = sum(t.value for t in all_trades)
buy_volume = sum(t.value for t in all_trades if t.side == 'BUY')
sell_volume = sum(t.value for t in all_trades if t.side == 'SELL')
```

### CSV 导出

```python
# 准备数据
export_data = []
for t in all_trades:
    export_data.append({
        '时间': datetime.fromtimestamp(t.timestamp).strftime('%Y-%m-%d %H:%M:%S'),
        '方向': t.side,
        '价格': t.price,
        '数量': t.size,
        '金额': t.value,
        '钱包地址': t.proxy_wallet,
    })

df = pd.DataFrame(export_data)
csv = df.to_csv(index=False).encode('utf-8-sig')

# 下载按钮
st.download_button(
    label="📥 下载 CSV",
    data=csv,
    file_name="market_trades.csv",
    mime="text/csv",
)
```

## ⚠️ 注意事项

### 1. 加载时间

大量数据需要更长的加载时间：
- 1000 笔：约 8 秒
- 5000 笔：约 20 秒
- 10000 笔：约 30 秒

**建议**：
- 不着急时选择大数量
- 快速查看时选择小数量

### 2. API 限制

- 单次请求最多 10000 笔
- 超过部分无法获取
- 市场总交易可能 > 10000

**解决方法**：
- 已关闭市场：数据固定，10000 笔已经很多
- 活跃市场：只能获取最近的交易

### 3. 内存占用

大量数据会占用浏览器内存：
- 10000 笔交易 ≈ 5-10 MB
- 图表渲染需要额外内存
- 老旧设备可能卡顿

**建议**：
- 电脑配置好：可以选 10000
- 配置一般：建议 2000-5000
- 配置较低：建议 500-1000

## 📝 更新日志

### v1.5 (2025-12-26)
- ✅ 扩大市场交易数据限制（500 → 10000）
- ✅ 添加市场交易数量选择器
- ✅ 添加市场交易详细统计面板
- ✅ 添加 CSV 数据导出功能
- ✅ 改进数据展示和说明

### v1.4 (2025-12-26)
- ✅ 改进市场状态筛选
- ✅ 可查看已关闭市场

## 🚀 快速开始

```bash
# 启动 Dashboard
./run_address_tracking.sh

# 查看已关闭市场的全部交易
1. 筛选：🔴 只看已关闭
2. 选择市场
3. 切换到 "🔄 市场对比分析"
4. 市场交易数量：选择 10000
5. 查看统计 & 下载 CSV
```

---

**更新时间**: 2025-12-26  
**版本**: 1.5  
**状态**: ✅ 完成并测试


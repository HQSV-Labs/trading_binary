# Polymarket 15分钟周期双向套利策略文档

**策略代号**： Gabagool-Arbitrage  
**适用平台**： Polymarket  
**标的资产**： (BTC、ETH) 价格预测 15分钟  
**时间窗口**： 15分钟期权 (15-Minute Binary Markets)  
**核心逻辑**： 机械式套利 (Mechanical Arbitrage) / 波动率剥头皮 (Volatility Scalping)

## 1. 策略概述

本策略不依赖于对标的资产（BTC/ETH）未来价格涨跌的预测。其核心在于利用短期二元期权市场中因市场情绪、恐慌或贪婪导致的价格低效，通过非对称建仓，使得"YES"和"NO"两个对立结果的组合持仓成本低于 $1.00（理论赔付值）。一旦组合成本低于 $1.00 且双边持仓数量平衡，无论市场最终结果如何，交易者均可获得数学上锁定的无风险收益。

## 2. 核心数学模型

### 2.1 基础定义

工程师需在内存中实时维护以下变量：

- $Qty_{YES}, Qty_{NO}$：当前持有的份额数量
- $Cost_{YES}, Cost_{NO}$：当前持有的总支出（美元）
- $Avg_{YES}, Avg_{NO}$：当前的平均持仓成本

**计算公式**：
- $Avg_{YES} = \frac{Cost_{YES}}{Qty_{YES}}$（当 $Qty_{YES} > 0$）
- $Avg_{NO} = \frac{Cost_{NO}}{Qty_{NO}}$（当 $Qty_{NO} > 0$）
- $Cost_{Total} = Cost_{YES} + Cost_{NO}$：总投入资金（美元）

### 2.2 关键指标：配对成本（Pair Cost）

配对成本是衡量建仓效率的核心指标，计算公式为：

$$
PairCost = Avg_{YES} + Avg_{NO}
$$

**重要规则**：
- 如果只买入单边（如只有 YES 持仓），未持仓的一边应使用**当前市场中间价**，而不是默认值 0.5
- 例如：只买入 YES 100 份 @ $0.40，当前 NO 市场价为 $0.60，则配对成本 = $0.40 + $0.60 = $1.00
- 只有当两边都有持仓时，才使用实际的平均持仓成本
- **目标**：通过非对称建仓，使配对成本 < $0.98（考虑 Polymarket 2% 手续费），从而在结算时锁定利润

**策略能否盈利的唯一判据是配对成本是否低于结算价（$1.00）**：

$$
Pair Cost < 0.98 \text{ (考虑 Polymarket 2\% 手续费)}
$$

### 2.3 准入判定公式（Entry Gate）

每次买入 $\Delta q$ 数量、价格为 $P$ 的份额前，必须满足：

$$
\frac{Cost_{Current} + (P \times \Delta q)}{Qty_{Current} + \Delta q} + Avg_{Opposite} < 0.98
$$

> **注**：$Avg_{Opposite}$ 是另一边的当前均价
> - 若另一边**有持仓**：使用实际平均持仓成本
> - 若另一边**无持仓**：使用**当前市场中间价**（不是 0.5！）
> - 这样确保配对成本计算准确：只买入单边时，配对成本 = 买入价 + 市场价 ≈ 1.0

**操作前模拟计算**：
在执行任何买单前，假设以价格 $P$ 买入数量 $\Delta q$，计算新的配对成本：
- 新数量： $Qty_{New} = Qty_{Current} + \Delta q$
- 新成本： $Cost_{New} = Cost_{Current} + (P \times \Delta q)$
- 判断条件： 只有当 **新配对成本 < 0.98** (考虑 Polymarket 2% 手续费) 时，才执行买入。

**目标价格计算**：
- **初始建仓**（无持仓）：$P_{target} = 0.98 - Avg_{Opposite}$
- **后续买入**（已有持仓）：根据当前持仓成本，反向计算满足配对成本条件的最高买入价
- **重要**：买入价格不固定在某区间，而是根据公式动态计算，只要满足配对成本 < 0.98 即可

### 2.4 利润锁定公式（Stop Condition）

当满足以下条件时，程序停止一切买入动作，等待结算：

$$
\min(Qty_{YES}, Qty_{NO}) > (Cost_{YES} + Cost_{NO})
$$

**解释**：这意味着你持有的最少那一方的份额数量（即最差情况下的赔付金额）已经超过了你的总投入成本。此时，无论 BTC/ETH 价格暴涨、暴跌还是横盘，你已确保盈利。

**确定性利润（Safe Profit）计算**：

$$
\text{Profit} = \min(Qty_{YES}, Qty_{NO}) - (Cost_{YES} + Cost_{NO})
$$

## 3. 市场机理与机会来源

### 理论基础

在二元市场中，理论上 $Price(YES) + Price(NO)$ 应恒等于 $1.00$。

### 现实偏差

在极短的时间窗口（15分钟）内，价格波动剧烈。市场参与者往往因追涨杀跌导致一方价格暴跌（如 YES 跌至 0.20），随后迅速反转（YES 回升至 0.82）。

### 套利机会

这种剧烈波动创造了时间差。交易者不需要同时买入，而是分别在 YES 便宜时买入 YES，在 NO 便宜时买入 NO，从而"磨低"平均成本。

## 4. 核心功能模块 (SOP)

### 模块 A：高频监控 (Monitor)

- **频率**：毫秒级（WebSocket 接入）
- **目标**：监控 BTC 和 ETH 15分钟的事件，监控这些事件的 YES 和 NO 的价格实时变化
- **初始建仓触发**：当 YES 或 NO 任何一方价格进入 0.35 - 0.50 价格区间时，激活买入逻辑（仅用于初始建仓）

**第一阶段：数据监控与初始化**

在 Dashboard 或程序中建立监控面板，实时追踪以下四个核心数据：
- $Qty_{YES}$ (当前 YES 持仓量)
- $Qty_{NO}$ (当前 NO 持仓量)
- $Cost_{YES}$ (YES 总花费)
- $Cost_{NO}$ (NO 总花费)

### 模块 B：异步下单 (Execution)

- **逻辑**：采用非对称建仓。永远只买入当前被市场低估（便宜）的一方
- **禁止市价单**：为防止滑点，必须使用限价单（Limit Order）
- **目标价格计算**：根据准入判定公式反向推算目标买入价
  - **初始建仓**：价格监控在 0.35-0.50 区间触发预警后，使用公式 `target_price = 0.98 - opposite_avg` 计算目标价
  - **后续买入**：根据当前持仓情况，通过 `calculate_target_price()` 函数计算，确保买入后配对成本 < 0.98
  - **关键**：后续买入价格**不限制在 0.35-0.50 区间**，只要满足配对成本条件即可

**第二阶段：非对称建仓 (Asymmetric Entry)**

原则： 永远只买入当前被市场低估（便宜）的一方
- **初始建仓**：价格进入 0.35-0.50 区间时触发
- **后续买入**：通过公式计算目标价格，确保配对成本 < 0.98，价格可能超出 0.35-0.50 区间

### 模块 C：动态平衡 (Rebalancing)

- **目标状态**：保持 $Qty_{YES} \approx Qty_{NO}$
- **阈值设定**：当两边数量差超过 20% 时，调高弱势方的挂单优先级

**第三阶段：动态平衡 (Rebalancing)**

随着仓位的建立，主要目标是保持双边持仓数量的平衡。
- 目的： 当数量相等时，对冲效果最强，且能够最大化"保证赔付"的金额。

**第四阶段：利润锁定与停止 (Lock & Stop)**

实时监控利润锁定条件，一旦满足立即停止开仓。

**第五阶段：循环**

由于 15 分钟市场的快速结算特性，该策略需高频重复。一个周期结束后（或利润锁定后），释放资金进入下一个 15 分钟窗口。

## 5. 案例分析 (基于 Gabagool 实盘)

### 场景复盘

在某 15 分钟窗口内，通过多次分散买入：
- **多头端**： 累计买入 1266.72 份 YES，均价 $0.517，花费 $655。
- **空头端**： 累计买入 1294.98 份 NO，均价 $0.449，花费 $581。

### 数据核算

- **配对成本**： $0.517 + 0.449 = 0.966$ （显著低于 $1.00$）
- **总成本**： $655 + 581 = 1236$ 美元
- **最小保底赔付**： $\min(1266.72, 1294.98) \times \$1 = \$1266.72$
- **净利润**： $1266.72 - 1236 = \$30.72$

## 6. 工程师开发重点 (Tech Stack & Performance)

### 低延迟架构

- 使用 Python (Asyncio) 或 Go 语言
- 核心数据（成本、均价）存储在内存中，严禁在买入判定逻辑中读写数据库

### API 接入

- 必须使用平台的 WebSocket 接口获取 Ticker/Orderbook
- 对于链上平台，需配置私有 RPC 节点以提速

### 异常处理 (Safety Valve)

- **单边保护**：若一方价格跌至接近 0 且无成交，停止买入另一方，防止亏损扩大
- **时间截止**：在结算前 60 秒停止所有操作，避免因流动性枯竭导致的滑点

## 7. 风控模块 (Risk Control Module)

### 7.1 引言 (Introduction)

#### 7.1.1 目的

本模块旨在构建一道"安全防火墙"，拦截任何违反数学套利逻辑、导致敞口过大或资金面临不可控风险的交易指令。风控模块具有最高执行优先级，任何交易指令必须先通过风控校验返回 PASS 后方可发送至交易所。

#### 7.1.2 范围

本需求覆盖：交易前置校验（Pre-trade Validation）、订单执行限制（Order Constraints）、持仓监控（Position Monitoring）及系统熔断机制（Circuit Breakers）。

### 7.2 全局参数配置 (Global Configuration)

系统需支持通过配置文件（如 `config.json` 或环境变量）热加载以下硬性阈值。

| 参数 Key | 类型 | 示例值 | 描述 |
|---------|------|--------|------|
| `MAX_TOTAL_CAPITAL` | Float | 1000.0 | 账户最大允许动用的总资金（USD）。 |
| `MAX_POS_PER_WINDOW` | Float | 200.0 | 单个 15 分钟合约窗口的最大持仓成本上限。 |
| `MIN_EXPECTED_ROI` | Float | 0.02 | 最小利润率 (2%)。即：合成配对成本必须 $\le 0.98$。 |
| `MAX_DELTA_RATIO` | Float | 0.20 | 最大允许单边敞口比例 (20%)。 |
| `MAX_SLIPPAGE` | Float | 0.01 | 订单价格相对于盘口的最大允许滑点 (1%)。 |
| `SETTLEMENT_BUFFER_SECONDS` | Int | 60 | 结算前缓冲时间（秒），避免流动性枯竭导致的滑点。 |
| `MAX_UNHEDGED_SEC` | Int | 120 | 单边敞口最大滞留时间（秒），超时强制停止交易。 |
| `MAX_PAIR_COST` | Float | 0.98 | 最大允许配对成本，超过此值无法盈利（考虑 Polymarket 2% 手续费）。 |
| `MAX_LOSS_RATIO` | Float | 0.1 | 最大亏损比例（10%），超过此比例停止交易。 |

### 7.3 功能需求 (Functional Requirements)

#### 7.3.1 [RCM-01] 交易前置盈利性校验 (Profitability Gate)

**描述**：在发出任何 BUY 指令前，必须计算当前操作是否符合套利数学逻辑。

**逻辑**：
1. 获取拟交易方向（如 YES）的 Limit_Price。
2. 获取反方向（如 NO）的当前市场最优卖一价（Best Ask）。
3. 计算 Simulated_Pair_Cost = Limit_Price + Best_Ask_Opposite + Fee_Buffer。
4. 判定：若 Simulated_Pair_Cost > (1.00 - MIN_EXPECTED_ROI)，则拒绝该订单。

**异常处理**：返回错误码 `ERR_NO_ARB_SPACE`。

#### 7.3.2 [RCM-02] 动态敞口限制 (Dynamic Delta Limit)

**描述**：防止因网络延迟或部分成交导致单边持仓过重，无法拉回平衡。

**逻辑**：
1. 模拟成交后的持仓：New_YES, New_NO。
2. 计算不平衡率（Delta Ratio）：

$$
\text{Ratio} = \frac{|New_{YES} - New_{NO}|}{\max(New_{YES}, New_{NO})}
$$

3. 判定：若 Ratio > MAX_DELTA_RATIO，则拒绝该订单。

**异常处理**：返回错误码 `ERR_DELTA_EXCEEDED`。

### 7.4 终止条件 (Stop Conditions)

#### 7.4.1 问题场景

**核心问题**：如果所有条件都不满足，只能买到 YES（或只能买到 NO），那么终止条件是什么？

**答案**：多重风险控制终止条件。当只能买入单边时，系统会检查以下终止条件，**任何一个满足都会停止交易**。

#### 7.4.2 终止条件列表

##### 1. 利润锁定 ✅

**条件**：`min(Qty_YES, Qty_NO) > (Cost_YES + Cost_NO)`

**逻辑**：
- 如果双边持仓且已锁定利润
- **停止交易**

**原因**：已确保盈利，无需继续交易

**示例**：
```
双边持仓：
- YES: 100 份，成本 $40
- NO: 100 份，成本 $50
- 总成本: $90
- 最小赔付: min(100, 100) = 100 > 90
✅ 利润已锁定，停止交易
```

##### 2. 单边持仓时间限制 ⏱️

**条件**：单边持仓时间超过 `MAX_UNHEDGED_SEC`（默认 120 秒）

**逻辑**：
- 如果只有 YES 持仓，且持续超过 120 秒无法买入 NO
- 或者只有 NO 持仓，且持续超过 120 秒无法买入 YES
- **停止交易**

**原因**：单边持仓时间过长，说明市场条件不满足套利要求，继续持有风险过大

**示例**：
```
时间 0:00 - 买入 YES 100 份 @ $0.40（初始建仓，价格在 0.35-0.50 区间）
时间 0:30 - NO 价格 $0.65，配对成本 = $0.40 + $0.65 = $1.05 > $1.00，不满足准入条件
时间 1:00 - NO 价格 $0.70，配对成本 = $0.40 + $0.70 = $1.10 > $1.00，不满足准入条件
时间 2:00 - ⚠️ 单边持仓超过 120 秒，停止交易
```

##### 3. 配对成本过高 💰

**条件**：当前配对成本 > `MAX_PAIR_COST`（默认 0.98）

**逻辑**：
- 如果只有 YES 持仓，配对成本 = YES 平均价 + NO 市场中间价
- 如果配对成本 > 0.98，说明**无法盈利**（因为结算时最多只能得到 $1.0，扣除 2% 手续费后实际得到 $0.98）
- **停止交易**

**原因**：配对成本超过 0.98 意味着无论市场结果如何，都无法盈利（考虑 Polymarket 2% 手续费）

**示例**：
```
YES 持仓：100 份 @ $0.40（平均价 $0.40）
NO 市场价：$0.65
配对成本 = $0.40 + $0.65 = $1.05 > $1.00
⚠️ 配对成本过高，停止交易
```

##### 4. 最大亏损保护 🛡️

**条件**：当前市值 / 成本 < (1 - `MAX_LOSS_RATIO`)（默认 0.9，即亏损超过 10%）

**逻辑**：
- 如果只有 YES 持仓，当前市值 = YES 数量 × YES 当前市场价
- 如果 当前市值 / 成本 < 0.9，说明亏损超过 10%
- **停止交易**

**原因**：防止单边持仓在不利行情下继续亏损

**示例**：
```
YES 持仓：100 份 @ $0.40（成本 $40）
YES 当前市场价：$0.35
当前市值 = 100 × $0.35 = $35
亏损率 = 1 - ($35 / $40) = 12.5% > 10%
⚠️ 亏损过大，停止交易
```

##### 5. 总资金限制 💵

**条件**：总投入成本 > `MAX_TOTAL_CAPITAL`（默认 $1000）

**逻辑**：
- 如果总投入（YES 成本 + NO 成本）超过 $1000
- **停止交易**

**原因**：防止过度投入资金

##### 6. 单个窗口持仓限制 📊

**条件**：总投入成本 > `MAX_POS_PER_WINDOW`（默认 $200）

**逻辑**：
- 如果单个 15 分钟窗口的持仓成本超过 $200
- **停止交易**

**原因**：限制单个市场的风险敞口

##### 7. 结算时间限制 ⏰

**条件**：距离结算时间 < `SETTLEMENT_BUFFER_SECONDS`（默认 60 秒）

**逻辑**：
- 如果距离市场结算时间少于 60 秒
- **停止交易**

**原因**：避免在结算前因流动性枯竭导致的滑点

#### 7.4.3 终止条件优先级总结

**单边持仓的终止条件**（按优先级）：

1. ✅ **利润锁定**：双边持仓且已盈利
2. ⏱️ **时间限制**：单边持仓超过 120 秒
3. 💰 **配对成本**：配对成本 > 0.98（无法盈利，考虑 2% 手续费）
4. 🛡️ **亏损保护**：亏损率 > 10%
5. 💵 **资金限制**：总投入 > $1000
6. 📊 **窗口限制**：单个窗口持仓 > $200
7. ⏰ **时间截止**：距离结算 < 60 秒

**核心原则**：**任何一个条件满足，立即停止交易，保护资金安全**

### 7.5 实现位置

#### 风险控制模块
- **文件**：`src/risk/stop_conditions.py`
- **类**：`RiskController`
- **方法**：`check_stop_conditions()`

#### 配置参数
- **文件**：`config.py`
- 所有参数都可以通过配置文件调整

#### Dashboard 集成
- **文件**：`dashboard.py`
- 实时显示风险控制状态和终止原因

### 7.6 使用示例

#### 场景 1：只能买到 YES

```
时间线：
00:00 - 买入 YES 100 份 @ $0.40（初始建仓，价格在 0.35-0.50 区间，成本 $40）
00:30 - NO 价格 $0.65，配对成本 = $0.40 + $0.65 = $1.05 > $1.00，不满足准入条件
01:00 - NO 价格 $0.70，配对成本 = $0.40 + $0.70 = $1.10 > $1.00，不满足准入条件
01:30 - NO 价格 $0.68，配对成本 = $0.40 + $0.68 = $1.08 > $1.00，不满足准入条件
02:00 - ⚠️ 单边持仓超过 120 秒，停止交易

说明：后续买入 NO 的价格不限制在 0.35-0.50 区间，但需要满足配对成本 < $0.98 的条件（考虑 2% 手续费）。
     由于 NO 价格过高，导致配对成本超过 $0.98，无法盈利，因此不执行买入。
```

#### 场景 2：配对成本过高

```
YES 持仓：100 份 @ $0.40（平均价 $0.40）
NO 市场价：$0.65
配对成本 = $0.40 + $0.65 = $1.05

⚠️ 配对成本 $1.05 > $0.98，无法盈利（考虑 2% 手续费），停止交易
```

#### 场景 3：亏损过大

```
YES 持仓：100 份 @ $0.40（成本 $40）
YES 当前市场价：$0.35（价格下跌）
当前市值 = 100 × $0.35 = $35
亏损率 = 12.5% > 10%

⚠️ YES 持仓亏损过大（亏损率 12.5% > 10%），停止交易
```

## 8. 测试用例 (Test Cases for Dev)

### Case 1: 初始买入

YES 价格 0.45，买入 100 份。计算出 NO 的最高可接受买入价。

### Case 2: 极端行情

YES 价格瞬间从 0.8 跌至 0.2，验证程序能否在几毫秒内捕捉到并执行买入。

### Case 3: 利润锁定

模拟两边持仓平衡后，总投入 90 刀，单边最小份额 91 份，验证程序是否自动进入 Stop 状态。

## 9. 给工程师的建议

请优先实现实时 Pair Cost 的 Dashboard 监控面板，方便我们在实操中观察成本的变化曲线。

> 你想让我再补充一些关于"手续费（Slippage & Fee）"如何自动计入成本公式的细节吗？

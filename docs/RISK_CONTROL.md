# 风险控制与终止条件文档

## 问题：单边持仓的终止条件

**场景**：如果所有条件都不满足，只能买到 YES（或只能买到 NO），那么终止条件是什么？

## 答案：多重风险控制终止条件

当只能买入单边时，系统会检查以下终止条件，**任何一个满足都会停止交易**：

---

## 1. 单边持仓时间限制 ⏱️

**条件**：单边持仓时间超过 `MAX_UNHEDGED_SEC`（默认 120 秒）

**逻辑**：
- 如果只有 YES 持仓，且持续超过 120 秒无法买入 NO
- 或者只有 NO 持仓，且持续超过 120 秒无法买入 YES
- **停止交易**

**原因**：单边持仓时间过长，说明市场条件不满足套利要求，继续持有风险过大

**示例**：
```
时间 0:00 - 买入 YES 100 份 @ $0.40
时间 0:30 - NO 价格 $0.65，不在买入区间
时间 1:00 - NO 价格 $0.70，不在买入区间
时间 2:00 - ⚠️ 单边持仓超过 120 秒，停止交易
```

---

## 2. 配对成本过高 💰

**条件**：当前配对成本 > `MAX_PAIR_COST`（默认 1.0）

**逻辑**：
- 如果只有 YES 持仓，配对成本 = YES 平均价 + NO 市场中间价
- 如果配对成本 > 1.0，说明**无法盈利**（因为结算时最多只能得到 $1.0）
- **停止交易**

**原因**：配对成本超过 1.0 意味着无论市场结果如何，都无法盈利

**示例**：
```
YES 持仓：100 份 @ $0.40（平均价 $0.40）
NO 市场价：$0.65
配对成本 = $0.40 + $0.65 = $1.05 > $1.00
⚠️ 配对成本过高，停止交易
```

---

## 3. 最大亏损保护 🛡️

**条件**：当前市值 / 成本 < (1 - `MAX_LOSS_RATIO`)（默认 0.9，即亏损超过 10%）

**逻辑**：
- 如果只有 YES 持仓，当前市值 = YES 数量 × YES 当前市场价
- 如果 当前市值 / 成本 < 0.9，说明亏损超过 10%
- **停止交易**

**原因**：防止单边持仓在不利行情下继续亏损

**示例**：
```
YES 持仓：100 份 @ $0.40（成本 $40）
YES 当前市场价：$0.35
当前市值 = 100 × $0.35 = $35
亏损率 = 1 - ($35 / $40) = 12.5% > 10%
⚠️ 亏损过大，停止交易
```

---

## 4. 总资金限制 💵

**条件**：总投入成本 > `MAX_TOTAL_CAPITAL`（默认 $1000）

**逻辑**：
- 如果总投入（YES 成本 + NO 成本）超过 $1000
- **停止交易**

**原因**：防止过度投入资金

---

## 5. 单个窗口持仓限制 📊

**条件**：总投入成本 > `MAX_POS_PER_WINDOW`（默认 $200）

**逻辑**：
- 如果单个 15 分钟窗口的持仓成本超过 $200
- **停止交易**

**原因**：限制单个市场的风险敞口

---

## 6. 结算时间限制 ⏰

**条件**：距离结算时间 < `SETTLEMENT_BUFFER_SECONDS`（默认 60 秒）

**逻辑**：
- 如果距离市场结算时间少于 60 秒
- **停止交易**

**原因**：避免在结算前因流动性枯竭导致的滑点

---

## 7. 利润锁定 ✅

**条件**：`min(Qty_YES, Qty_NO) > (Cost_YES + Cost_NO)`

**逻辑**：
- 如果双边持仓且已锁定利润
- **停止交易**

**原因**：已确保盈利，无需继续交易

---

## 实现位置

### 风险控制模块
- **文件**：`src/risk/stop_conditions.py`
- **类**：`RiskController`
- **方法**：`check_stop_conditions()`

### 配置参数
- **文件**：`config.py`
- 所有参数都可以通过配置文件调整

### Dashboard 集成
- **文件**：`dashboard.py`
- 实时显示风险控制状态和终止原因

---

## 使用示例

### 场景：只能买到 YES

```
时间线：
00:00 - 买入 YES 100 份 @ $0.40（成本 $40）
00:30 - NO 价格 $0.65，不在买入区间（0.35-0.50）
01:00 - NO 价格 $0.70，不在买入区间
01:30 - NO 价格 $0.68，不在买入区间
02:00 - ⚠️ 单边持仓超过 120 秒，停止交易
```

### 场景：配对成本过高

```
YES 持仓：100 份 @ $0.40（平均价 $0.40）
NO 市场价：$0.65
配对成本 = $0.40 + $0.65 = $1.05

⚠️ 配对成本 $1.05 > $1.00，无法盈利，停止交易
```

### 场景：亏损过大

```
YES 持仓：100 份 @ $0.40（成本 $40）
YES 当前市场价：$0.35（价格下跌）
当前市值 = 100 × $0.35 = $35
亏损率 = 12.5% > 10%

⚠️ YES 持仓亏损过大（亏损率 12.5% > 10%），停止交易
```

---

## 配置建议

根据实际需求调整以下参数：

```python
# config.py
MAX_UNHEDGED_SEC = 120  # 单边持仓最大时间（秒）
MAX_PAIR_COST = 1.0     # 最大允许配对成本
MAX_LOSS_RATIO = 0.1    # 最大亏损比例（10%）
MAX_TOTAL_CAPITAL = 1000.0  # 最大总资金
MAX_POS_PER_WINDOW = 200.0  # 单个窗口最大持仓
SETTLEMENT_BUFFER_SECONDS = 60  # 结算前缓冲时间
```

---

## 总结

**单边持仓的终止条件**（按优先级）：

1. ✅ **利润锁定**：双边持仓且已盈利
2. ⏱️ **时间限制**：单边持仓超过 120 秒
3. 💰 **配对成本**：配对成本 > 1.0（无法盈利）
4. 🛡️ **亏损保护**：亏损率 > 10%
5. 💵 **资金限制**：总投入 > $1000
6. 📊 **窗口限制**：单个窗口持仓 > $200
7. ⏰ **时间截止**：距离结算 < 60 秒

**核心原则**：**任何一个条件满足，立即停止交易，保护资金安全**


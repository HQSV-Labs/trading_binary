# 市场分析功能使用指南

## 📋 功能概述

**新的分析逻辑**：
```
搜索市场 → 选择市场 → 获取所有交易 → 标记目标地址
```

与之前的逻辑对比：

| 旧逻辑 | 新逻辑 |
|--------|--------|
| 输入地址 → 查找该地址的交易 → 按市场分组 | 搜索市场 → 获取市场所有交易 → 标记目标地址 |
| 只能看到该地址有交易的市场 | 可以查看任意市场的所有交易 |
| 适合追踪某个地址的全部活动 | 适合分析特定市场的全部交易情况 |

## 🎯 使用场景

### 场景1：分析 BTC 15分钟已关闭市场

**目标**：查看某个已结束的 BTC 15分钟市场的所有交易情况

**步骤**：
1. 选择"🎯 BTC 15分钟市场"模式
2. 选择"🔴 已关闭"状态
3. 点击"🔍 搜索市场"
4. 从列表中选择感兴趣的市场
5. （可选）输入目标地址以高亮标记
6. 点击"📊 获取并分析"
7. 查看完整的交易图表和统计

### 场景2：对比自己的交易 vs 市场

**目标**：看看自己的交易时机和价格相比市场如何

**步骤**：
1. 搜索并选择市场
2. 输入自己的钱包地址
3. 点击"📊 获取并分析"
4. 图表中：
   - **大标记 + 黑边框** = 你的交易
   - **小标记 + 半透明** = 其他人的交易
5. 对比分析：
   - 你的买入时机 vs 其他人
   - 你的价格 vs 平均价格
   - 你的仓位占比

### 场景3：研究特定市场的交易策略

**目标**：分析某个市场的交易模式和趋势

**步骤**：
1. 搜索并选择市场
2. 不输入地址（或留空）
3. 获取所有交易数据
4. 查看：
   - 交易时间分布
   - 价格波动
   - 买卖比例
   - 交易量分布
5. 导出 CSV 进行深度分析

## 🚀 快速开始

### 1. 启动 Dashboard

```bash
./run_market_analysis.sh
```

或：

```bash
source venv/bin/activate
streamlit run dashboard_market_analysis.py --server.port 8503
```

访问：`http://localhost:8503`

### 2. 搜索 BTC 15分钟已关闭市场

**搜索模式**：
- 🎯 **BTC 15分钟市场**（推荐）
  - 自动筛选 BTC 15分钟市场
  - 使用 tag_id=102467 精确筛选
  - 只返回真正的 BTC 15分钟市场

- 🔍 **自定义关键词**
  - 输入任意关键词（如 "BTC", "ETH", "Trump"）
  - 搜索包含该关键词的市场
  - 适合查找其他类型的市场

**市场状态**：
- 🔴 **已关闭**（推荐）
  - 数据完整且不再变化
  - 适合完整分析
  - 可以放心获取所有交易

- 🟢 **活跃**
  - 市场还在进行中
  - 数据会持续变化
  - 适合实时监控

### 3. 选择市场

从搜索结果中选择要分析的市场：

```
🔴 已关闭 Bitcoin Up or Down - September 13, 2:15AM-2:30AM ET
🔴 已关闭 Bitcoin Up or Down - September 13, 2:00AM-2:15AM ET
🔴 已关闭 Bitcoin Up or Down - September 13, 1:15AM-1:30AM ET
...
```

点击展开"📋 市场详情"可以查看：
- 完整问题描述
- Condition ID
- 市场状态
- Polymarket 链接

### 4. 输入目标地址（可选）

**默认地址**：`0x6031b6eed1c97e853c6e0f03ad3ce3529351f96d`

**说明**：
- 可以输入任意以太坊地址
- 留空则不进行标记，显示所有交易
- 输入后会自动：
  - 查找该地址的代理钱包
  - 在图表中高亮标记
  - 统计该地址的交易数量

### 5. 获取并分析

点击"📊 获取并分析"后：

1. **自动分页获取所有交易**
   - 突破 10,000 笔限制
   - 获取市场的全部交易历史
   - 显示实时进度

2. **如果输入了目标地址**
   - 自动查找代理钱包
   - 在所有交易中标记该地址的交易
   - 统计占比和交易量

3. **显示完整统计**
   - 总交易数
   - 交易者数
   - 买入/卖出统计
   - 目标地址统计（如果有）

## 📊 图表说明

### 主图表

**上图：交易价格随时间**
- X轴：时间
- Y轴：价格 ($)
- Marker：
  - 🔺 买入 YES（绿色三角）
  - ●  买入 NO（浅绿圆圈）
  - 🔻 卖出 YES（红色倒三角）
  - ■  卖出 NO（粉红方块）

**下图：交易数量随时间**
- X轴：时间
- Y轴：数量 (shares)
- 堆叠柱状图

### 标记说明

#### 其他人的交易（背景）
- **Marker大小**：8px（小）
- **透明度**：0.4（半透明）
- **边框**：细线
- **颜色**：对应交易类型的颜色

#### 目标地址的交易（高亮）
- **Marker大小**：16px（大）
- **透明度**：1.0（完全不透明）
- **边框**：3px 黑色粗边框
- **图例**：带 ⭐ 标记
- **Hover**：显示 "⭐ XX (目标地址)"

### 交互功能

1. **Hover 查看详情**
   - 鼠标悬停在任意 marker 上
   - 显示：数量、价格、金额、时间

2. **图例控制**
   - 点击图例可以显示/隐藏对应的数据
   - 双击图例可以只显示该数据

3. **缩放和平移**
   - 鼠标滚轮：缩放
   - 拖动：平移
   - 双击：重置视图

## 📈 统计信息

### 基本统计

```
┌──────────┬──────────┬──────────┬──────────┬──────────┐
│ 总交易数 │ 交易者数 │ 买入交易 │ 卖出交易 │ ⭐目标地址│
│  1,234   │    89    │   789    │   445    │    23    │
└──────────┴──────────┴──────────┴──────────┴──────────┘
```

### 详细统计（展开查看）

**价格统计**：
- 最低价
- 最高价
- 平均价

**交易量统计**：
- 总交易额
- 买入总额
- 卖出总额

**时间范围**：
- 开始时间
- 结束时间
- 持续时间

**目标地址统计**（如果有）：
- 总交易数
- 买入/卖出笔数
- 交易额
- 占比

## 📥 导出功能

### CSV 导出

点击"📥 下载 CSV"可以导出所有交易数据。

**CSV 文件包含**：
- 时间
- 方向（BUY/SELL）
- 价格
- 数量
- 金额
- **是否为目标地址**（⭐ 是/否）
- 钱包地址
- 市场标题
- 市场链接

### Excel 分析技巧

1. **筛选目标地址的交易**
   ```
   筛选 "是否为目标地址" = "⭐ 是"
   ```

2. **按价格排序**
   ```
   排序 "价格" 列
   ```

3. **计算统计**
   ```
   使用 AVERAGE(), SUM(), COUNT() 等函数
   ```

4. **透视表分析**
   ```
   行：时间段
   列：买入/卖出
   值：交易额
   ```

## 🎯 分析技巧

### 1. 识别交易时机

**问题**：我的买入时机好吗？

**方法**：
1. 输入自己的地址
2. 在图表中找到 ⭐ 标记
3. 对比：
   - 你的买入价 vs 后续最低价
   - 你的卖出价 vs 后续最高价
   - 你的交易时间 vs 市场高峰

### 2. 对比交易策略

**问题**：我的交易策略是激进还是保守？

**方法**：
1. 查看你的交易分布
2. 对比其他人的交易密度
3. 分析：
   - 你的交易频率 vs 平均频率
   - 你的单笔金额 vs 平均金额
   - 你的持仓时间 vs 平均持仓时间

### 3. 研究市场趋势

**问题**：市场是如何演变的？

**方法**：
1. 不输入地址，查看所有交易
2. 观察图表：
   - 价格走势（上涨/下跌/震荡）
   - 交易量变化（增加/减少）
   - 买卖比例（偏向 YES 还是 NO）
3. 分析关键时刻：
   - 价格剧烈波动时发生了什么？
   - 交易量激增时是什么情况？

### 4. 发现异常交易

**问题**：有没有异常的大额交易？

**方法**：
1. 在图表中找特别大的 marker
2. Hover 查看详情
3. 导出 CSV 按金额排序
4. 分析：
   - 大额交易的时机
   - 大额交易的价格
   - 大额交易的影响

## ⚠️ 注意事项

### 1. 数据量

**已关闭市场**：
- ✅ 推荐使用分页获取所有交易
- ✅ 数据不会变化，可以放心分析
- ⚠️ 超大市场可能有数万笔交易，需要1-5分钟

**活跃市场**：
- ⚠️ 数据在持续变化
- ⚠️ 分页获取期间可能有新交易
- ⚠️ 建议只获取最近的交易

### 2. 代理钱包

Polymarket 使用代理钱包机制：
- 你输入的是**主地址**
- 系统会自动查找**代理钱包**
- 交易记录在**代理钱包**中
- 图表中标记的是所有关联的代理钱包

### 3. 性能

**获取时间**：
- 1,000 笔：~2秒
- 10,000 笔：~15-20秒
- 50,000 笔：~1-2分钟
- 100,000 笔：~2-5分钟

**内存占用**：
- 1万笔 ≈ 10-20 MB
- 10万笔 ≈ 100-200 MB

**建议**：
- 在获取大量数据前，确保网络稳定
- 超大市场建议在非高峰时段获取
- 获取完成后可以导出 CSV 备份

### 4. 图表渲染

**大量数据点**：
- 超过 10,000 个点可能影响渲染速度
- 图表交互可能有延迟
- 建议使用图例控制显示/隐藏部分数据

## 🔧 技术细节

### API 端点

**市场搜索**：
```
GET https://gamma-api.polymarket.com/markets
参数：
  - tag_id=102467（BTC/ETH 15分钟市场）
  - closed=true/false
  - limit=100
```

**交易获取**：
```
GET https://data-api.polymarket.com/trades
参数：
  - market={condition_id}
  - limit=1000
  - offset=0, 1000, 2000, ...
```

### 分页逻辑

```python
offset = 0
all_trades = []

while True:
    batch = fetch(condition_id, limit=1000, offset=offset)
    if len(batch) == 0:
        break
    all_trades.extend(batch)
    offset += 1000
    
    if len(batch) < 1000:
        break  # 已获取完毕
```

## 📚 相关文档

- [地址追踪功能](docs/ADDRESS_TRACKING.md)
- [分页获取功能](docs/PAGINATION_FEATURE.md)
- [交易标记功能](HIGHLIGHT_TRACKING_UPDATE.md)

## 🎉 总结

**这个功能适合**：
- ✅ 分析特定市场的全部交易情况
- ✅ 对比自己的交易 vs 市场
- ✅ 研究市场趋势和交易策略
- ✅ 查找已关闭市场的历史数据

**与原功能的配合使用**：
- **原功能**（地址追踪）：追踪某个地址的所有市场活动
- **新功能**（市场分析）：分析特定市场的所有交易

**推荐组合**：
1. 先用原功能找到该地址活跃的市场
2. 再用新功能深度分析这些市场
3. 对比该地址在不同市场的表现

---

**功能版本**: V2.0  
**发布日期**: 2025-12-26  
**状态**: ✅ 可用  

🚀 **现在你可以自由分析任何 BTC 15分钟市场的所有交易了！**

